---
title: "ReEDS-India Results"
author: "Created by: National Renewable Energy Laboratory (NREL)"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    toc: true
    toc_float:
      collapsed: false
    number_sections: true
    fig_width: 10
    df_print: paged
    
params:
  gdxlist: 'Base#output_tmp_toy.gdx##'
  gamsdir: "C:/GAMS/win64/24.7"
  final.year: 2047
  curt.switch: 1
---

```{r setOptions, echo=F, warning=F, message=F, error=F, cache=F, include = F}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#!!!!!!!!!!!!!!!!!!!!!!!!!! USER INPUTS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!#

# Uncommenting will overwrite any command line arguments provided by the python workflow

#gdxfiles = c("public" = "output_public_toy.gdx")

#!!!!!!!!!!!!!!!!!!!!!!!! END USER INPUTS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!#

# load packages, data and plotting functions
if(!require("pacman")){
  install.packages('devtools')
  require(remotes)
  install_version("pacman", version = "0.4.6", repos = "http://cran.us.r-project.org")
}

pacman::p_load(gdxrrw, ggplot2, data.table, RColorBrewer, 
               scales, rmarkdown, mapproj, gdata, zoo, viridis)

#!!!!!!!!!!!!!!!!!!!!!!!!!! PROCESSING COMMAND LINE ARGUMENTS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!#

if(!exists("gdxfiles")){
gdxlist = strsplit(params$gdxlist, '##', fixed = TRUE)[[1]]

gdxfiles = c()

  for (i in 1:length(gdxlist)){
      svector = strsplit(gdxlist[i], split = '#', fixed = TRUE)[[1]]
      sname = svector[1]
      spath = svector[2]
      f = c(spath)
      names(f) =sname
      gdxfiles = c(gdxfiles, f)
  }
}

curt.switch = params$curt.switch

gamsdir = params$gamsdir
igdx(gamsdir)

#hacky way to get parent directory... R is dumb
wd <- getwd()
setwd("..")
parent <- getwd()
setwd(wd) 
gdx.dir = file.path(parent, "E_Outputs","gdxfiles")

final.year = params$final.year

# load analysis parameters
input.params = fread("data/analysis_parameters.csv")
input.params[input.params == ""] = NA
gen.order = input.params[!is.na(Gen.Order), Gen.Order]
gen.type.map = na.omit(input.params[,.(reeds.category, Type = factor(Type, levels = gen.order))])
gen.colors = input.params[!is.na(Plot.Color),Plot.Color]
names(gen.colors) = input.params[!is.na(Gen.Type),Gen.Type]

focus.regions = input.params[,Focus.Regions]

source("scripts/plot_functions_IC.R")
source("scripts/plot_functions_AR.R")
source("scripts/plot_parameters.R")
source("scripts/gdxr_functions.R")
source("scripts/query_gdx_files.R")

# set figure width by number of scenarios
n.scenario = length(gdxfiles)
n.year = length(unique(cap$Year))

png_path = "plots/png/png_output_"    

# set up default options for chunks, turn off error or warning messages
knitr::opts_chunk$set(echo=F, comment=NA, warning=F, message=F, include=T, 
                      dev='png', cache = F, fig.path = png_path)

```

# Analaysis Plots and Figures
```{r analysis-metadata, echo=FALSE}
metadata = data.table(Scenario = names(gdxfiles),
                      File = gdxfiles,
                      `Number of years` = sum(unique(cap$Year)<=final.year),
                      `Final analysis year` = final.year)
knitr::kable(metadata)

```

# Firm Capacity
```{r firm-capacity, echo=FALSE,  fig.height = 5, rows.print = n.year, fig.width = 10}
p = plot_firm_capacity(aggregate.by = 'nation', years = final.year)
p$plot
p$data

p = plot_firm_capacity(aggregate.by = 'region')
p$plot
p$data

```

# Capacity
```{r total-capacity, echo=FALSE,  fig.height = 4, rows.print = n.year, fig.width = 10}

# Total capacity by year, national
p1 = plot_cap_by_year(aggregate.by = "nation",years = 2017:2047)

if(n.scenario==1 & final.year == 2047){
  p1$plot = p1$plot + 
  geom_vline(xintercept= 2022.5, linetype = "dashed", color = "darkgrey", size = 1.25) +
  annotate("text", x = c(2019,2026), y=1300, label = c("Planned", "Modeled"), size = 5,
           color = c("grey30", "firebrick"))
}

p1$plot

p1$data

p2 = plot_cap_mix(aggregate.by = "nation", years = 2017:2047)

p2$plot

p2$data

```

## Capacity as frac Peak Demand
```{r capacity-peak, echo=FALSE, rows.print = n.year}

# Installed capacity as fraction of peak demand, national by year
p =tab_cap_frac_peak()
p$data

```

## Capacity by region
```{r capacity-region, echo=FALSE,  fig.height = 8}

# Total capacity by year, region
p = plot_cap_by_year(aggregate.by = "region")

p$plot

p = plot_cap_by_year(aggregate.by = "state", state.filter = c('Andhra_Pradesh','Tamil_Nadu',
                                                            'Karnataka','Telangana','Maharashtra',
                                                            'Gujarat','Madhya_Pradesh', 'Rajasthan'))

p$plot

```

## New capacity
```{r new-capacity, echo=FALSE,  fig.height = 6}

# New capacity by year, national
p = plot_new_capacity(aggregate.by = "nation")

p$plot


```

## New capacity difference
```{r new-capacity-diff, echo=FALSE,  fig.height = 4}

# New capacity difference from reference scenario
p = plot_new_capacity_diff(aggregate.by = "nation")

p$plot

```

# Generation
```{r generation, echo=FALSE,  fig.height = 4}

# Generation by year, national
p = plot_generation(aggregate.by = "nation")
  
p$plot

p$mix

```

## Generation mix
```{r generation-mix, echo=FALSE, rows.print = n.year, fig.height = 3.5, fig.width = 8}
p = plot_generation(aggregate.by = "nation", plot_curt = FALSE)

min_year = min(p$mix_data[,Year])
max_year = max(p$mix_data[,Year])
ggplot(data = p$mix_data) + 
  geom_area(aes(x=Year,y=gen.mix,fill=Type), color = 'grey20') +
  labs(y = 'Generation mix', x = NULL) +
  scale_x_continuous(breaks=seq(min_year-1, max_year, 2),expand = c(0,0)) +
  scale_y_continuous(labels = scales::percent, expand = c(0,0)) +
  scale_fill_manual("",values = gen.colors, drop = TRUE) +
  plot_theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~scenario)

# Generation mix by year
p$mix

```

## Capacity factor
```{r cap-factor, echo=FALSE,  fig.height = 3, fig.width = 7}

# Generation by year, national
p = plot_capacity_factor(aggregate.by = "nation", category.filter = c('Gas CC','Gas CT'))

p$plot


```

## Timeslice generation
```{r timeslice-gen-nation, echo=FALSE, fig.height = 4, fig.width = 8}

# Generation by year, national
p = plot_timeslice_generation(aggregate.by = "nation", year = final.year, type = 'capacity')

# add load as dot
tot.load = demand[Year == final.year, .(Demand = sum(demand)/1000), 
                  by = .(scenario, time_slice = time_slice)]

tot.load = merge(tot.load, ts.map, by = 'time_slice')

p = p$plot + ggtitle(paste('Snapshot in',final.year) ) +
  geom_point(data = tot.load, aes(x=time, y=Demand, shape="Demand"), inherit.aes = F)

p

```

## Region timeslice generation
```{r timeslice-gen-region, echo=FALSE, fig.height = 6}

# Generation by year, national
p = plot_timeslice_generation(aggregate.by = "region", year = final.year, type = 'capacity')

# add load as dot

tot.load = demand[Year == final.year, 
                  .(Demand = sum(demand)/1000), by = .(scenario, region, time_slice = time_slice)]

p$plot + ggtitle(paste('Snapshot in',final.year) ) + 
  geom_point(data = tot.load, aes(x=time_slice, y=Demand, shape="Demand"), inherit.aes = F) +
 theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) 

```

## Curtailment iterations
```{r curtailment-iter, echo=FALSE, fig.height = 3, fig.width = 6}

if(curt.switch == 1 ){
 if('season' %in% names(curt_iter)){
  curt_plots = plot_curt_iter()
  
  curt_plots
  }
}

```

## CC iterations
```{r cc-iter, echo=FALSE, fig.height = 3, fig.width = 6}

if(curt.switch == 1 ){
 if('season' %in% names(cc_iter)){
  cc_plots = plot_cc_iter()
  
  cc_plots[1]
  cc_plots[2]
  }
}
```

## CC by region
```{r cc-region, echo=FALSE, fig.height = 6, fig.width = 12}
if(curt.switch == 1 ){
 if('season' %in% names(cc_iter)){
 cc_plots[3]
 }
}
```

## Storage operations 
```{r timeslice-storage, echo=FALSE, fig.height = 5}

# Storage by year, national
p = plot_storage_ops(aggregate.by = "nation", year = 'year.max') 

p$plot + ggtitle(paste('Snapshot in',final.year) )

```

## Operating reserve provision
```{r opres-tot, echo=FALSE, fig.height = 3, fig.width = 5}

# Operating reserves by year, national
p = plot_opres_tot(aggregate.by = "nation") 

p$plot +  labs(y=NULL,x=NULL) + theme(strip.background = element_blank(), strip.text.x = element_blank()) 
```

## Operating reserves snapshot
```{r timeslice-opres, echo=FALSE, fig.height = 4}

# Operating reserves by timeslice, national
p = plot_opres(aggregate.by = "nation", year = 'year.max') 

p$plot + ggtitle(paste('Snapshot in',final.year) )
```

# Total system cost
```{r system-cost, echo=FALSE,  fig.height = 4}

# Present value of total system costs
p = plot_system_costs_all(aggregate.by = 'nation', year = final.year)

p

```

## Region system cost
```{r system-cost-region, echo=FALSE,  fig.height = 4}

# Present value of total system costs
p = plot_system_costs_all(aggregate.by = 'region', year = final.year)

p

```

## Technology cost
```{r tech-cost, echo=FALSE,  fig.height = 6}

# Present value of total system costs
p = plot_system_costs_all(aggregate.by = 'technology', year = final.year)

p

```

## Marginal cost
```{r marginal-cost, echo=FALSE,  fig.height = 6}

# Generation by year, national
p = plot_marginal_cost(aggregate.by = "nation")

p$plot + facet_wrap(~scenario, nrow = n.scenario)


```

# RE capacity by resource region
```{r map-rs-cap, echo=FALSE,  fig.height = 8}
map_rs_capacity(category = 'WIND', palette = 'Blues', years = final.year)

map_rs_capacity(category = 'UPV', palette = 'Oranges', years = final.year)

map_rs_capacity(category = 'DUPV', palette = 'Reds', years = final.year)

```

# Capacity maps
```{r map-re-capacity, echo=FALSE,  fig.height = 6}
wind.cap.map = map_capacity(category = "WIND", palette = 'Blues', years = final.year)

wind.cap.map + ggtitle(paste('Wind capacity in',final.year) )

upv.cap.map = map_capacity(category = 'UPV', palette = 'Oranges', years = final.year)

upv.cap.map + ggtitle(paste('UPV capacity in',final.year) )

dupv.cap.map = map_capacity(category = 'DUPV', palette = 'Reds', years = final.year)

dupv.cap.map + ggtitle(paste('DUPV capacity in',final.year) )

if(curt.switch == 1){
  if('Timeslice' %in% names(curt)){
  curt.map = map_curtailment(palette = 'YlOrRd', year = final.year)
  
    if("ggplot" %in% class(curt.map)){
      curt.map + ggtitle(paste('Curtailment capacity in', final.year) )
    }else{curt.map}
  }
}

cap.map = map_capacity(category = 'SUPERCRITICAL-COAL', palette = 'Greys', years = final.year)
cap.map + ggtitle(paste('Super-Coal capacity in ',final.year) )

cap.map = map_capacity(category = 'CCGT-LNG', palette = 'Greens', years = final.year)
cap.map + ggtitle(paste('CCGT capacity in ',final.year) )

cap.map = map_capacity(category = 'CT-GAS', palette = 'Purples', years = final.year)
cap.map + ggtitle(paste('CT capacity in ',final.year) )

```

# Transmission investments
```{r tx-investment, echo=FALSE, rows.print = 50, fig.width = 6}

p = plot_tx_inv()

p$plot

p$data


```


## Transmission investment map
```{r map-tx-investment, echo=FALSE, fig.width = 8}

map.tx.inv <- map_tx_inv()

map.tx.inv

```

# Power flow during highest RE time slices
```{r map-tslc-flow, echo=FALSE, fig.width = 10}

map_tslc_flow(year = final.year, by = 'state', tech = 'Wind')
map_tslc_flow(year = final.year, by = 'region', tech = 'Wind')

map_tslc_flow(year = final.year, by = 'state', tech = 'Solar PV')
map_tslc_flow(year = final.year, by = 'region', tech = 'Solar PV')

```

# Power flow maps
```{r map-tx-flow, echo=FALSE, fig.width = 10}

map.tx.flow.state = map_tx_flow(year = final.year, by = 'state')

map.tx.flow.state + ggtitle(paste('Total transmission flow in',final.year) )

map_max_flow(year = final.year, by = 'state')



map.tx.flow.region = map_tx_flow(year = final.year, by = 'region')

map.tx.flow.region + ggtitle(paste('Total transmission flow in',final.year) )

map_max_flow(year = final.year, by = 'region')


```




